<html>
  <head>
    <meta charset="utf-8" />
    <title> I can has regex simplify </title>

    <script type="text/javascript" src="../../lib/noam.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery.js"></script>
    <script type="text/javascript" src="https://raw.github.com/twitter/bootstrap/gh-pages/assets/js/bootstrap.js"></script>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css"/>
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }

      .monospaceRegex {
        font-family: monospace;
      }

      .deletedRegexPart {
        background-color: lightpink;
        font-weight: bold;
      }

      .addedRegexPart {
        background-color: lightgreen;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Regular Expressions Gym</h1>
      <p>Slim your regexes one step at a time!</p>

      <p>
        <button id="generateRegex" class="btn">Generate a random regular expression</button>
      </p>
      <p>
      	<input id="originalRegex" type="text" class="input-block-level monospaceRegex" placeholder="or write your own">
      </p>
      <p>
        <button id="simplifyRegex" class="btn" data-loading-text="Wait for itâ€¦">Simplify!</button>
        <button id="simplifyRegexStep" class="btn">Step</button>
      </p>
      <p>
        <label class="span2" style="float: left;" for="sourceRegex">Source regex:</label>
        <div id="sourceRegex" type="text" class="input-block-level monospaceRegex"></div>
        <label class="span2" style="float: left;" for="resultRegex">Minimized regex:</label>
        <div id="resultRegex" type="text" class="input-block-level monospaceRegex"></div>
        <label class="span2" style="float: left;" for="appliedPatterns">Applied pattern:</label>
        <div id="appliedPatterns" type="text" class="input-block-level monospaceRegex"></div>
        <br>
        <label class="span3" for="resultRegexList">Minimization history:</label>
        <br>
        <div style="margin-left: 20px;" id="resultRegexList" type="text" class="input-block-level monospaceRegex"></div>
      </p>

    </div> <!-- /container -->

    <script type="text/javascript">
      // taken from http://rosettacode.org/wiki/Longest_common_subsequence#JavaScript
      function lcs(x, y) {
        var s, i, j, m, n, lcs = [], row = [], c = [], left, diag, latch;
        //make sure shorter string is the column string
        if(m<n){s=x;x=y;y=s;}
        m = x.length;
        n = y.length;
        //build the c-table
        for(j=0;j<n;row[j++]=0);
        for(i=0;i<m;i++){
          c[i] = row = row.slice();
          for(diag=0,j=0;j<n;j++,diag=latch){
            latch=row[j];
            if(x[i] == y[j]){row[j] = diag+1;}
            else{
              left = row[j-1]||0;
              if(left>row[j]){row[j] = left;}
            }
          }
        }
        i--,j--;
        //row[j] now contains the length of the lcs
        //recover the lcs from the table
        while(i>-1&&j>-1){
          switch(c[i][j]){
            default: j--;
              lcs.unshift(x[i]);
            case (i&&c[i-1][j]): i--;
              continue;
            case (j&&c[i][j-1]): j--;
          }
        }
        return lcs.join('');
      }

      var currentRegex = null;
      var sourceRegex = null;
      $("#generateRegex").click(function() {
        $("#originalRegex").val(noam.re.string.random(20, "abc", {}));
        currentRegex = $("#originalRegex").val();
        $("#resultRegex").html("");
        $("#sourceRegex").html("");
        $("#appliedPatterns").html("");
        $("#resultRegexList").html("");
        $("#simplifyRegex").attr("disabled", false);
        $("#simplifyRegexStep").attr("disabled", false);
      });

      $("#simplifyRegex").click(function() {
      	$("#simplifyRegex").button('loading');
      	setTimeout(function() {
      	  var regex = $("#originalRegex").val();
      	  var result = noam.re.string.simplify(regex);
          sourceRegex = currentRegex;
      	  currentRegex = result;
          $("#sourceRegex").html(sourceRegex);
          $("#resultRegex").html(result);
          $("#simplifyRegex").button('reset');
          setTimeout(function() {
            $("#simplifyRegex").attr("disabled", true);
            $("#simplifyRegexStep").attr("disabled", true);
            setTimeout(colorize, 0);
            }, 0);
        }, 0);
      });

      function lcs_intervals(str1, str2) {
        var intervals = [];

        var start = 0;
        var end = 0;

        var i=0;

        while (i < str2.length) {
          if (str2[i] !== str1[end]) {
            end += 1
          } else {
            if (start !== end) {
              intervals.push([start, end]);
            }

            start = end;
            i += 1;
            end += 1;
            start += 1;
          }
        }

        if (end < str1.length) {
          intervals.push([end, str1.length]);
        }

        return intervals;
      }

      /* Should eventually color a meaningful (changed or deleted) part of the minimized regex */
      function colorize() {
        var sourceText = $("#sourceRegex").text();
        var resultText = $("#resultRegex").text();
        var lcsText = lcs(sourceText, resultText);

        var deletedIntervals = lcsText.length > sourceText.length ? [] : lcs_intervals(sourceText, lcsText);
        var addedIntervals = resultText.length > lcsText.length ? [] : lcs_intervals(lcsText, resultText);

        colorDiv("sourceRegex", deletedIntervals, "deletedRegexPart");
        colorDiv("resultRegex", addedIntervals, "addedRegexPart");
      }

      $("#simplifyRegexStep").click(function() {
        console.log(currentRegex);
        var stepResult = simplifyStep(currentRegex);
        var result = stepResult[0];
        var appliedPatterns = stepResult[1];
        if (result === currentRegex) {
          $("#simplifyRegexStep").attr("disabled", true);
          $("#simplifyRegex").attr("disabled", true);
        } else {
          sourceRegex = currentRegex;
          currentRegex = result;

          $("#sourceRegex").html(sourceRegex);
          $("#resultRegex").html(result);
          $("#appliedPatterns").html(appliedPatterns[appliedPatterns.length - 1]);
          var allResults =  $("#resultRegexList").html() + "<br/>" + result;
          $("#resultRegexList").html(allResults);
          setTimeout(colorize, 0);
        }
      });

      function colorDiv(divId, intervals, cssClass) {
        var regex = $("#" + divId).html();

        var start = 0;
        var out = "";

        for (var i=0; i<intervals.length; i++) {
          out += regex.slice(start, intervals[i][0]);
          out += '<font class="' + cssClass + '">' + regex.slice(intervals[i][0], intervals[i][1]) + '</font>';
          start = intervals[i][1];
        }

        out += regex.slice(start);

        $("#" + divId).html(out);
      }

      function simplifyStep(regex) {
  	    var config = {numIterations : 1, appliedPatterns : []};
	      var result = noam.re.string.simplify(regex, config);
	      var numOfLastStepPatterns = config.appliedPatterns.length;
	      while (result === regex) {
	        config.numIterations += 1;
	        config.appliedPatterns = [];
	        var result = noam.re.string.simplify(regex, config);
	        if (config.appliedPatterns.length == 0 || config.appliedPatterns.length == numOfLastStepPatterns)
	          break;
	        numOfLastStepPatterns = config.appliedPatterns.length;
        }
        return [result, config.appliedPatterns];
      }

      $("#originalRegex").change(function() {
        currentRegex = $("#originalRegex").val();
      });
    </script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-36346935-1']);
      _gaq.push(['_setDomainName', 'auto']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
